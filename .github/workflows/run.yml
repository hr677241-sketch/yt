name: Content Sync

on:
  workflow_dispatch:
    inputs:
      force_batch:
        description: 'Override batch size'
        required: false
      skip_delay:
        description: 'Skip random delay (yes/no)'
        required: false
        default: 'no'
  schedule:
    # PKT peak windows (UTC+5)
    - cron: '17 4 * * *'    # 09:17 PKT
    - cron: '43 6 * * *'    # 11:43 PKT
    - cron: '08 9 * * *'    # 14:08 PKT
    - cron: '51 11 * * *'   # 16:51 PKT
    - cron: '27 14 * * *'   # 19:27 PKT
    - cron: '03 16 * * *'   # 21:03 PKT
    - cron: '39 18 * * *'   # 23:39 PKT

concurrency:
  group: content-pipeline
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # Increased to prevent timeouts

    steps:
      - name: ðŸ§  Human Behavior Engine
        id: brain
        run: |
          # Convert to PKT (UTC+5)
          HOUR=$(( ($(date -u +%-H) + 5) % 24 ))
          DOW=$(TZ="Asia/Karachi" date +%u)
          MINUTE=$(date -u +%-M)
          ROLL=$((RANDOM % 100))
          ROLL2=$((RANDOM % 100))
          ROLL3=$((RANDOM % 100))

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ§  Decision Engine (PKT Timezone)"
          echo "   ðŸ• Current: $(TZ='Asia/Karachi' date '+%H:%M %A')"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [[ "${{ inputs.force_batch }}" != "" ]]; then
            echo "BATCH_SIZE=${{ inputs.force_batch }}" >> $GITHUB_ENV
            echo "RUN_DELAY=15" >> $GITHUB_ENV
            echo "INTER_DELAY_MIN=10" >> $GITHUB_ENV
            echo "INTER_DELAY_MAX=30" >> $GITHUB_ENV
            echo "âœ… Manual override active"
            exit 0
          fi

          # â”€â”€ TIME-OF-DAY MODEL (PKT) â”€â”€
          if [ "$HOUR" -lt 7 ]; then
            SKIP_PCT=90; PERIOD="ðŸŒ™ Deep night"
          elif [ "$HOUR" -lt 10 ]; then
            SKIP_PCT=45; PERIOD="ðŸŒ… Early morning"
          elif [ "$HOUR" -lt 14 ]; then
            SKIP_PCT=15; PERIOD="â˜€ï¸ Morning"
          elif [ "$HOUR" -lt 18 ]; then
            SKIP_PCT=20; PERIOD="ðŸŒ¤ï¸ Afternoon"
          elif [ "$HOUR" -lt 23 ]; then
            SKIP_PCT=10; PERIOD="ðŸŒ† Evening (Peak)"
          else
            SKIP_PCT=60; PERIOD="ðŸŒ™ Late night"
          fi

          echo "   $PERIOD â†’ Base skip: ${SKIP_PCT}%"

          # â”€â”€ DAY ADJUSTMENTS â”€â”€
          if [ "$DOW" -eq 5 ]; then SKIP_PCT=$((SKIP_PCT + 20)); fi # Friday
          if [ "$DOW" -eq 6 ]; then SKIP_PCT=$((SKIP_PCT + 15)); fi # Saturday
          if [ "$DOW" -eq 1 ] || [ "$DOW" -eq 2 ]; then SKIP_PCT=$((SKIP_PCT - 10)); fi

          # Clamp
          if [ "$SKIP_PCT" -gt 95 ]; then SKIP_PCT=95; fi
          if [ "$SKIP_PCT" -lt 5 ]; then SKIP_PCT=5; fi

          # â”€â”€ SKIP CHECK â”€â”€
          if [ "$ROLL" -lt "$SKIP_PCT" ]; then
            echo "BATCH_SIZE=0" >> $GITHUB_ENV
            echo "RUN_DELAY=0" >> $GITHUB_ENV
            echo "   ðŸ˜´ Decided to SKIP this run."
            exit 0
          fi

          # â”€â”€ BATCH SIZE â”€â”€
          if [ "$ROLL2" -lt 50 ]; then BATCH=1
          elif [ "$ROLL2" -lt 80 ]; then BATCH=2
          elif [ "$ROLL2" -lt 95 ]; then BATCH=3
          else BATCH=4; fi

          # Night Cap
          if [ "$HOUR" -lt 7 ] || [ "$HOUR" -ge 23 ]; then
            if [ "$BATCH" -gt 2 ]; then BATCH=2; fi
          fi
          echo "BATCH_SIZE=$BATCH" >> $GITHUB_ENV

          # â”€â”€ DELAYS â”€â”€
          if [ "$ROLL3" -lt 30 ]; then DELAY=$(( RANDOM % 780 + 120 ))
          elif [ "$ROLL3" -lt 75 ]; then DELAY=$(( RANDOM % 1800 + 900 ))
          else DELAY=$(( RANDOM % 2400 + 2700 )); fi
          
          # Cap delay to fit in 180m timeout
          if [ "$DELAY" -gt 3600 ]; then DELAY=3600; fi
          
          echo "RUN_DELAY=$DELAY" >> $GITHUB_ENV

          IMIN=$(( RANDOM % 150 + 30 ))
          IMAX=$(( IMIN + RANDOM % 360 + 120 ))
          echo "INTER_DELAY_MIN=$IMIN" >> $GITHUB_ENV
          echo "INTER_DELAY_MAX=$IMAX" >> $GITHUB_ENV

          echo "   âœ… RUNNING: Batch $BATCH, Delay $((DELAY/60))m"

      - name: â³ Natural Delay
        if: env.BATCH_SIZE != '0'
        run: |
          DELAY=${{ env.RUN_DELAY }}
          if [[ "${{ inputs.skip_delay }}" == "yes" ]]; then
            echo "â© Skipping delay"
          elif [ "$DELAY" -gt 0 ]; then
            echo "â˜• Waiting $((DELAY/60)) minutes..."
            sleep "$DELAY"
          fi

      - name: ðŸ“¥ Checkout
        if: env.BATCH_SIZE != '0'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ Setup Python
        if: env.BATCH_SIZE != '0'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        if: env.BATCH_SIZE != '0'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg tor torsocks > /dev/null 2>&1
          
          # Install Deno for JS execution (CAPTCHA bypass)
          curl -fsSL https://deno.land/install.sh | sh 2>/dev/null
          echo "$HOME/.deno/bin" >> $GITHUB_PATH

          pip install -U pip -q
          pip install -U yt-dlp google-api-python-client google-auth-oauthlib google-auth-httplib2 -q
          pip install -U "yt-dlp[default]" -q 2>/dev/null || true

          # Configure Tor
          sudo bash -c 'cat >> /etc/tor/torrc << EOF
          ExitNodes {us},{gb},{de},{fr},{nl},{se},{ca},{au},{jp}
          StrictNodes 0
          MaxCircuitDirtiness 60
          EOF'
          sudo service tor start
          sleep 10

      - name: ðŸš€ Run Pipeline
        if: env.BATCH_SIZE != '0'
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          YOUTUBE_TOKEN: ${{ secrets.YOUTUBE_TOKEN }}
          YOUTUBE_COOKIES_B64: ${{ secrets.YOUTUBE_COOKIES_B64 }}
          BATCH_SIZE: ${{ env.BATCH_SIZE }}
          INTER_DELAY_MIN: ${{ env.INTER_DELAY_MIN }}
          INTER_DELAY_MAX: ${{ env.INTER_DELAY_MAX }}
          PRIVACY: "public"
          ORDER: "oldest"
        run: python main.py

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f cookies.txt
          rm -rf dl/ out/

      - name: ðŸ’¾ Save Progress
        if: env.BATCH_SIZE != '0'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git pull origin main --rebase || git pull origin main
          git add history.txt
          git diff --staged --quiet || (git commit -m "ðŸ“ progress update [skip ci]" && git push)
