name: Content Sync

on:
  workflow_dispatch:
    inputs:
      force_batch:
        description: 'Override batch size'
        required: false
      skip_delay:
        description: 'Skip random delay (yes/no)'
        required: false
        default: 'no'
  schedule:
    # PKT peak windows (UTC+5) â€” irregular gaps
    - cron: '17 4 * * *'    # 09:17 PKT ðŸŒ…
    - cron: '43 6 * * *'    # 11:43 PKT â˜€ï¸
    - cron: '08 9 * * *'    # 14:08 PKT ðŸŒ¤ï¸
    - cron: '51 11 * * *'   # 16:51 PKT ðŸŒ¤ï¸
    - cron: '27 14 * * *'   # 19:27 PKT ðŸŒ†
    - cron: '03 16 * * *'   # 21:03 PKT ðŸŒ™
    - cron: '39 18 * * *'   # 23:39 PKT ðŸŒ™

concurrency:
  group: content-pipeline
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: ðŸ§  Human Behavior Engine
        id: brain
        run: |
          # Convert to PKT (UTC+5)
          HOUR=$(( ($(date -u +%-H) + 5) % 24 ))
          DOW=$(TZ="Asia/Karachi" date +%u)
          MINUTE=$(date -u +%-M)
          ROLL=$((RANDOM % 100))
          ROLL2=$((RANDOM % 100))
          ROLL3=$((RANDOM % 100))

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ§  Decision Engine"
          echo "   ðŸ• PKT: $(TZ='Asia/Karachi' date '+%H:%M %A')"
          echo "   ðŸŽ² Rolls: $ROLL / $ROLL2 / $ROLL3"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # â”€â”€ MANUAL OVERRIDE â”€â”€
          if [[ "${{ inputs.force_batch }}" != "" ]]; then
            echo "BATCH_SIZE=${{ inputs.force_batch }}" >> $GITHUB_ENV
            echo "RUN_DELAY=15" >> $GITHUB_ENV
            echo "INTER_DELAY_MIN=10" >> $GITHUB_ENV
            echo "INTER_DELAY_MAX=30" >> $GITHUB_ENV
            echo "âœ… Manual override: batch=${{ inputs.force_batch }}"
            exit 0
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # TIME-OF-DAY ACTIVITY MODEL (PKT)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #
          # Deep night  (0-6):   90% skip  (sleeping)
          # Early morn  (7-9):   45% skip  (chai, waking up)
          # Morning    (10-13):  15% skip  (active)
          # Afternoon  (14-17):  20% skip  (active)
          # Evening    (18-22):  10% skip  (peak â€” after work)
          # Late night (23):     60% skip  (winding down)

          if [ "$HOUR" -lt 7 ]; then
            SKIP_PCT=90
            PERIOD="ðŸŒ™ Deep night"
          elif [ "$HOUR" -lt 10 ]; then
            SKIP_PCT=45
            PERIOD="ðŸŒ… Early morning"
          elif [ "$HOUR" -lt 14 ]; then
            SKIP_PCT=15
            PERIOD="â˜€ï¸ Morning"
          elif [ "$HOUR" -lt 18 ]; then
            SKIP_PCT=20
            PERIOD="ðŸŒ¤ï¸ Afternoon"
          elif [ "$HOUR" -lt 23 ]; then
            SKIP_PCT=10
            PERIOD="ðŸŒ† Evening (peak)"
          else
            SKIP_PCT=60
            PERIOD="ðŸŒ™ Late night"
          fi

          echo "   $PERIOD â†’ base skip: ${SKIP_PCT}%"

          # â”€â”€ FRIDAY/SATURDAY (Pakistan weekend) â”€â”€
          if [ "$DOW" -eq 5 ]; then
            SKIP_PCT=$((SKIP_PCT + 20))
            echo "   ðŸ“… Friday (Jumu'ah): +20% skip"
          elif [ "$DOW" -eq 6 ]; then
            SKIP_PCT=$((SKIP_PCT + 15))
            echo "   ðŸ“… Saturday: +15% skip"
          fi

          # â”€â”€ MONDAY/TUESDAY BOOST â”€â”€
          if [ "$DOW" -eq 1 ] || [ "$DOW" -eq 2 ]; then
            SKIP_PCT=$((SKIP_PCT - 10))
            echo "   ðŸ“… Mon/Tue: -10% skip (upload day)"
          fi

          # â”€â”€ CLAMP â”€â”€
          if [ "$SKIP_PCT" -gt 95 ]; then SKIP_PCT=95; fi
          if [ "$SKIP_PCT" -lt 5 ]; then SKIP_PCT=5; fi

          echo "   ðŸ“Š Final skip chance: ${SKIP_PCT}%"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # SKIP DECISION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ "$ROLL" -lt "$SKIP_PCT" ]; then
            echo "BATCH_SIZE=0" >> $GITHUB_ENV
            echo "RUN_DELAY=0" >> $GITHUB_ENV
            echo ""
            echo "   ðŸ˜´ Skipping â€” natural break"
            exit 0
          fi

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # BATCH SIZE
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # 50% â†’ 1   30% â†’ 2   15% â†’ 3   5% â†’ 4

          if [ "$ROLL2" -lt 50 ]; then
            BATCH=1
          elif [ "$ROLL2" -lt 80 ]; then
            BATCH=2
          elif [ "$ROLL2" -lt 95 ]; then
            BATCH=3
          else
            BATCH=4
          fi

          # Late night cap
          if [ "$HOUR" -lt 7 ] || [ "$HOUR" -ge 23 ]; then
            if [ "$BATCH" -gt 2 ]; then
              BATCH=2
              echo "   ðŸŒ™ Night cap: max 2 videos"
            fi
          fi

          echo "   ðŸ“¦ Batch size: $BATCH"
          echo "BATCH_SIZE=$BATCH" >> $GITHUB_ENV

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # PRE-RUN DELAY
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ "$ROLL3" -lt 30 ]; then
            DELAY=$(( RANDOM % 780 + 120 ))
            echo "   â±ï¸ Quick start: $((DELAY/60))m"
          elif [ "$ROLL3" -lt 75 ]; then
            DELAY=$(( RANDOM % 1800 + 900 ))
            echo "   â±ï¸ Medium start: $((DELAY/60))m"
          else
            DELAY=$(( RANDOM % 2400 + 2700 ))
            echo "   â±ï¸ Slow start: $((DELAY/60))m"
          fi

          echo "RUN_DELAY=$DELAY" >> $GITHUB_ENV

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # INTER-VIDEO DELAY
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          IMIN=$(( RANDOM % 150 + 30 ))
          IMAX=$(( IMIN + RANDOM % 360 + 120 ))
          echo "INTER_DELAY_MIN=$IMIN" >> $GITHUB_ENV
          echo "INTER_DELAY_MAX=$IMAX" >> $GITHUB_ENV
          echo "   â³ Between videos: ${IMIN}sâ€“${IMAX}s"

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DECISION: Upload $BATCH after ~$((DELAY/60))min delay"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: â³ Natural Delay
        if: env.BATCH_SIZE != '0'
        run: |
          DELAY=${{ env.RUN_DELAY }}

          if [[ "${{ inputs.skip_delay }}" == "yes" ]]; then
            echo "â© Delay skipped (manual override)"
            sleep 5
          elif [ "$DELAY" -gt 0 ]; then
            MINS=$((DELAY / 60))
            echo "â˜• Simulating human delay: ~${MINS} minutes"

            CHUNK=300
            ELAPSED=0
            while [ "$ELAPSED" -lt "$DELAY" ]; do
              REMAINING=$((DELAY - ELAPSED))
              if [ "$REMAINING" -lt "$CHUNK" ]; then
                sleep "$REMAINING"
                ELAPSED=$DELAY
              else
                sleep $CHUNK
                ELAPSED=$((ELAPSED + CHUNK))
                echo "   â³ $((ELAPSED/60))m / ${MINS}m ..."
              fi
            done
            echo "   âœ… Starting now"
          fi

      - name: ðŸ“¥ Checkout
        if: env.BATCH_SIZE != '0'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ Setup Python
        if: env.BATCH_SIZE != '0'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        if: env.BATCH_SIZE != '0'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg tor torsocks > /dev/null 2>&1

          curl -fsSL https://deno.land/install.sh | sh 2>/dev/null
          echo "$HOME/.deno/bin" >> $GITHUB_PATH

          python -m pip install --upgrade pip -q
          pip install -U yt-dlp google-api-python-client google-auth-oauthlib google-auth-httplib2 -q
          pip install -U "yt-dlp[default]" -q 2>/dev/null || true

          echo "ðŸ“¦ yt-dlp $(yt-dlp --version)"

          sudo bash -c 'cat >> /etc/tor/torrc << EOF
          ExitNodes {us},{gb},{de},{fr},{nl},{se},{ca},{au},{jp}
          StrictNodes 0
          MaxCircuitDirtiness 60
          EOF'
          sudo service tor start
          sleep 10

      - name: ðŸš€ Run Pipeline
        if: env.BATCH_SIZE != '0'
        env:
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
          YOUTUBE_TOKEN: ${{ secrets.YOUTUBE_TOKEN }}
          YOUTUBE_COOKIES_B64: ${{ secrets.YOUTUBE_COOKIES_B64 }}
          BATCH_SIZE: ${{ env.BATCH_SIZE }}
          INTER_DELAY_MIN: ${{ env.INTER_DELAY_MIN }}
          INTER_DELAY_MAX: ${{ env.INTER_DELAY_MAX }}
          SPEED: "1.05"
          PRIVACY: "public"
          ORDER: "oldest"
        run: python main.py

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f cookies.txt
          rm -rf dl/ out/

      - name: ðŸ’¾ Save Progress
        if: env.BATCH_SIZE != '0'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git pull origin main --rebase || git pull origin main
          git add history.txt

          MSGS=(
            "update progress"
            "save checkpoint"
            "sync data"
            "update records"
            "checkpoint save"
            "progress update"
            "data sync"
            "save state"
          )
          MSG=${MSGS[$((RANDOM % ${#MSGS[@]}))]}

          git diff --staged --quiet || (git commit -m "ðŸ“ $MSG [skip ci]" && git push)
